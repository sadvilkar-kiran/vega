package handlers

import (
	"fmt"
	"net/http"

	"github.com/sadvilkar-kiran/vega"
	"github.com/sadvilkar-kiran/vega/render"
)

type Handlers struct {
	App    *vega.Vega
	Models interface{}
}

func (h *Handlers) Home(w http.ResponseWriter, r *http.Request) {
	err := h.App.Render.Page(w, r, "home", nil, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

func (h *Handlers) GoPage(w http.ResponseWriter, r *http.Request) {
	err := h.App.Render.GoPage(w, r, "home", nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

func (h *Handlers) JetPage(w http.ResponseWriter, r *http.Request) {
	err := h.App.Render.JetPage(w, r, "home", nil, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

func (h *Handlers) SessionTest(w http.ResponseWriter, r *http.Request) {
	h.App.Session.Put(r.Context(), "foo", "bar")
	val := h.App.Session.GetString(r.Context(), "foo")

	td := &render.TemplateData{
		StringMap: map[string]string{
			"foo": val,
		},
	}

	err := h.App.Render.Page(w, r, "sessions", nil, td)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// JSON is the handler to demonstrate JSON responses
func (h *Handlers) JSON(w http.ResponseWriter, r *http.Request) {
	var payload struct {
		ID        int64    `json:"id"`
		Name      string   `json:"name"`
		Hobbies   []string `json:"hobbies"`
		Framework string   `json:"framework"`
	}

	payload.ID = 1
	payload.Name = "Vega Framework"
	payload.Hobbies = []string{"Go", "Web Development", "Rapid Development"}
	payload.Framework = "Vega - Speed Up Your Development"

	err := h.App.WriteJSON(w, http.StatusOK, payload)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// XML is the handler to demonstrate XML responses
func (h *Handlers) XML(w http.ResponseWriter, r *http.Request) {
	type Payload struct {
		ID        int64    `xml:"id"`
		Name      string   `xml:"name"`
		Hobbies   []string `xml:"hobbies>hobby"`
		Framework string   `xml:"framework"`
	}

	var payload Payload
	payload.ID = 1
	payload.Name = "Vega Framework"
	payload.Hobbies = []string{"Go", "Web Development", "Rapid Development"}
	payload.Framework = "Vega - Speed Up Your Development"

	err := h.App.WriteXML(w, http.StatusOK, payload)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// TestCrypto demonstrates encryption/decryption functionality
func (h *Handlers) TestCrypto(w http.ResponseWriter, r *http.Request) {
	plainText := "Hello, Vega Framework!"
	fmt.Fprint(w, "Unencrypted: "+plainText+"\n")

	enc := vega.Encryption{
		Key: []byte(h.App.EncryptionKey),
	}

	encrypted, err := enc.Encrypt(plainText)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.Error500(w, r)
		return
	}

	fmt.Fprint(w, "Encrypted: "+encrypted+"\n")

	decrypted, err := enc.Decrypt(encrypted)
	if err != nil {
		h.App.ErrorLog.Println(err)
		h.App.Error500(w, r)
		return
	}

	fmt.Fprint(w, "Decrypted: "+decrypted+"\n")
}

// ShowCachePage displays the cache test page
func (h *Handlers) ShowCachePage(w http.ResponseWriter, r *http.Request) {
	err := h.App.Render.Page(w, r, "cache", nil, nil)
	if err != nil {
		h.App.ErrorLog.Println(err)
	}
}

// SaveInCache saves a value to cache
func (h *Handlers) SaveInCache(w http.ResponseWriter, r *http.Request) {
	var userInput struct {
		Name  string `json:"name"`
		Value string `json:"value"`
		CSRF  string `json:"csrf_token"`
	}

	err := h.App.ReadJSON(w, r, &userInput)
	if err != nil {
		h.App.Error500(w, r)
		return
	}

	err = h.App.Cache.Set(userInput.Name, userInput.Value)
	if err != nil {
		h.App.Error500(w, r)
		return
	}

	var resp struct {
		Error   bool   `json:"error"`
		Message string `json:"message"`
	}

	resp.Error = false
	resp.Message = "Saved in cache"

	_ = h.App.WriteJSON(w, http.StatusCreated, resp)
}

// GetFromCache retrieves a value from cache
func (h *Handlers) GetFromCache(w http.ResponseWriter, r *http.Request) {
	var userInput struct {
		Name string `json:"name"`
		CSRF string `json:"csrf_token"`
	}

	err := h.App.ReadJSON(w, r, &userInput)
	if err != nil {
		h.App.Error500(w, r)
		return
	}

	fromCache, err := h.App.Cache.Get(userInput.Name)
	if err != nil {
		var resp struct {
			Error   bool   `json:"error"`
			Message string `json:"message"`
		}
		resp.Error = true
		resp.Message = "Not found in cache!"
		_ = h.App.WriteJSON(w, http.StatusOK, resp)
		return
	}

	var resp struct {
		Error   bool   `json:"error"`
		Message string `json:"message"`
		Value   string `json:"value"`
	}

	resp.Error = false
	resp.Message = "Success"
	resp.Value = fromCache.(string)
	_ = h.App.WriteJSON(w, http.StatusOK, resp)
}

